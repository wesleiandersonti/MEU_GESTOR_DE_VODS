<Window x:Class="MeuGestorVODs.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:MeuGestorVODs"
        Title="{Binding WindowTitle}" Height="700" Width="1100"
        WindowStartupLocation="CenterScreen">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Window.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="#007ACC" Padding="15">
            <TextBlock Text="MEU GESTOR DE VODS" FontSize="20" FontWeight="Bold" Foreground="White"/>
        </Border>

        <!-- Config Panel -->
        <Grid Grid.Row="1" Background="#F5F5F5" Margin="10" Grid.IsSharedSizeScope="True">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- M3U URL -->
            <Grid Grid.Row="0" Margin="0,0,0,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="Label"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="URL M3u ou M3u8:" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                <Button Grid.Column="1" Content="Carregar" Click="LoadM3U_Click" Padding="15,5" Margin="0,0,5,0" Background="#4CAF50" Foreground="White" FontWeight="Bold"/>
                <ComboBox Grid.Column="2" x:Name="M3UUrlComboBox" IsEditable="True" Text="{Binding M3UUrl, UpdateSourceTrigger=PropertyChanged}" Padding="5"/>
                <Button Grid.Column="3" Content="Histórico" Click="ShowUrlHistory_Click" Padding="12,5" Margin="5,0,0,0" Background="#2196F3" Foreground="White"/>
                <Button Grid.Column="4" Content="Limpar Offline" Click="ClearOfflineUrls_Click" Padding="12,5" Margin="5,0,0,0" Background="#F44336" Foreground="White"/>
                <Button Grid.Column="5" Content="Analisar Link" Click="AnalyzeLinks_Click" Padding="12,5" Margin="5,0,0,0" Background="#3F51B5" Foreground="White" FontWeight="SemiBold"/>
            </Grid>

            <!-- Download Path -->
            <Grid Grid.Row="1" Margin="0,0,0,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="Label"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="Pasta Download:" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                <TextBox Grid.Column="1" Text="{Binding DownloadPath}" Padding="5" IsReadOnly="True"/>
                <Button Grid.Column="2" Content="Alterar" Click="BrowsePath_Click" Padding="15,5" Margin="10,0,0,0"/>
            </Grid>

            <!-- Local File -->
            <Grid Grid.Row="2" Margin="0,0,0,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="Label"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="Arquivo Local:" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                <Button Grid.Column="1" Content="Procurar" Click="BrowseLocalFile_Click" Padding="12,5" Margin="0,0,5,0" Background="#FF9800" Foreground="White"/>
                <TextBox Grid.Column="2" x:Name="LocalFileTextBox" Text="{Binding LocalFilePath}" Padding="5" IsReadOnly="True"/>
                <Button Grid.Column="3" Content="Analisar lista local" Click="LoadLocalFile_Click" Padding="15,5" Margin="5,0,0,0" Background="#4CAF50" Foreground="White" FontWeight="Bold"/>
            </Grid>

            <!-- Filter -->
            <Grid Grid.Row="3">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="Label"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="Filtrar:" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                <TextBox Grid.Column="1" Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}" Padding="5"/>
                <TextBlock Grid.Column="2" Text="Resultado:" VerticalAlignment="Center" Margin="10,0,6,0" FontWeight="SemiBold"/>
                <ComboBox Grid.Column="3" Width="140" ItemsSource="{Binding AnalysisFilterOptions}" SelectedItem="{Binding SelectedAnalysisFilter}" Padding="4"/>
            </Grid>

            <!-- IPTV Checker Progress -->
            <Grid Grid.Row="4" Margin="0,6,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="Label"/>
                    <ColumnDefinition Width="220"/>
                    <ColumnDefinition Width="220"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="Checker:" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                <ProgressBar Grid.Column="1" Height="16" Value="{Binding AnalysisProgressValue}" Maximum="100" VerticalAlignment="Center"/>
                <TextBlock Grid.Column="2" Text="{Binding AnalysisProgressText}" VerticalAlignment="Center" Margin="10,0,0,0" Foreground="#333"/>
                <TextBlock Grid.Column="3" Text="{Binding AnalysisSummaryText}" VerticalAlignment="Center" Margin="10,0,0,0" Foreground="#333" TextTrimming="CharacterEllipsis"/>
                <Button Grid.Column="4" Content="Remover Duplicados" Click="RemoveDuplicates_Click" Padding="10,4" Margin="8,0,0,0"/>
                <Button Grid.Column="5" Content="Exportar Resultado" Click="ExportAnalysis_Click" Padding="10,4" Margin="8,0,0,0" Background="#009688" Foreground="White"/>
            </Grid>
        </Grid>

        <!-- Main Content -->
        <Grid Grid.Row="2" Margin="10,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="10"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel - Entries -->
            <Border Grid.Column="0" BorderBrush="#CCCCCC" BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10,10,10,6">
                        <Button Content="{Binding ItemCountText}" Click="ItemsSummary_Click" Padding="12,5" Margin="0,0,8,0" FontWeight="SemiBold"/>
                        <Button Content="{Binding GroupCountText}" Click="GroupsSummary_Click" Padding="12,5" Margin="0,0,8,0" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding GroupFilterInfoText}" VerticalAlignment="Center" Foreground="#666"/>
                    </StackPanel>

                    <DataGrid Grid.Row="1" x:Name="EntriesList" ItemsSource="{Binding FilteredEntries}" 
                             AutoGenerateColumns="False" CanUserAddRows="False" 
                             SelectionMode="Extended" GridLinesVisibility="Horizontal"
                             PreviewMouseLeftButtonUp="EntriesList_PreviewMouseLeftButtonUp"
                             EnableRowVirtualization="True"
                             EnableColumnVirtualization="True"
                             VirtualizingPanel.IsVirtualizing="True"
                             VirtualizingPanel.VirtualizationMode="Recycling"
                             ScrollViewer.CanContentScroll="True">
                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow">
                                <Setter Property="Background" Value="White"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CheckStatus}" Value="{x:Static local:ItemStatus.Checking}">
                                        <Setter Property="Background" Value="#E3F2FD"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding CheckStatus}" Value="{x:Static local:ItemStatus.Ok}">
                                        <Setter Property="Background" Value="#E8F5E9"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding CheckStatus}" Value="{x:Static local:ItemStatus.Error}">
                                        <Setter Property="Background" Value="#FFEBEE"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.RowStyle>
                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected, Mode=TwoWay}" Width="30"/>
                            <DataGridTextColumn Header="Nome" Binding="{Binding Name}" Width="*"/>
                            <DataGridTextColumn Header="Grupo (Categoria | Subcategoria)" Binding="{Binding GroupDisplay}" Width="230"/>
                            <DataGridTextColumn Header="Status" Binding="{Binding StatusText}" Width="90"/>
                            <DataGridTextColumn Header="Servidor" Binding="{Binding ServerHost}" Width="150"/>
                            <DataGridTextColumn Header="Latência (ms)" Binding="{Binding ResponseTimeMs, StringFormat={}{0:F0}}" Width="95"/>
                            <DataGridTextColumn Header="Duplicado" Binding="{Binding DuplicateText}" Width="85"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <Border Grid.Row="2" Margin="10,8,10,0" BorderBrush="#D9D9D9" BorderThickness="1" Padding="8"
                            Visibility="{Binding GroupPanelVisibility}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="Grupos encontrados" FontWeight="SemiBold" Margin="0,0,0,6"/>
                            <TreeView Grid.Row="1" x:Name="GroupsTree" ItemsSource="{Binding GroupCategories}" SelectedItemChanged="GroupsTree_SelectedItemChanged" Height="170">
                                <TreeView.Resources>
                                    <HierarchicalDataTemplate DataType="{x:Type local:GroupCategoryItem}" ItemsSource="{Binding Groups}">
                                        <TextBlock Text="{Binding CategoryName}" FontWeight="SemiBold"/>
                                    </HierarchicalDataTemplate>
                                    <DataTemplate DataType="{x:Type local:GroupListItem}">
                                        <TextBlock Text="{Binding DisplayName}"/>
                                    </DataTemplate>
                                </TreeView.Resources>
                            </TreeView>
                        </Grid>
                    </Border>

                    <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="10">
                        <Button Content="Selecionar Todos" Click="SelectAll_Click" Padding="10,5" Margin="0,0,5,0"/>
                        <Button Content="Desmarcar Todos" Click="DeselectAll_Click" Padding="10,5" Margin="0,0,20,0"/>
                        <Button Content="Baixar Selecionados" Click="DownloadSelected_Click" Padding="15,5" Background="#4CAF50" Foreground="White"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Right Panel - Downloads e Score -->
            <Border Grid.Column="2" BorderBrush="#CCCCCC" BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Monitoramento" FontWeight="Bold" FontSize="14" Margin="10"/>

                    <TabControl Grid.Row="1" Margin="6">
                        <TabItem Header="Downloads">
                            <ScrollViewer>
                                <ItemsControl ItemsSource="{Binding Downloads}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="10">
                                                <StackPanel>
                                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                                    <ProgressBar Value="{Binding Progress}" Maximum="100" Height="15" Margin="0,5"/>
                                                    <Grid>
                                                        <TextBlock Text="{Binding Status}" FontSize="11" Foreground="Gray"/>
                                                        <TextBlock Text="{Binding Progress, StringFormat='{}{0:F0}%'}" FontSize="11" 
                                                                  HorizontalAlignment="Right"/>
                                                    </Grid>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </TabItem>
                        <TabItem Header="Score Servidores">
                            <DataGrid ItemsSource="{Binding ServerScores}"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="False"
                                      IsReadOnly="True"
                                      GridLinesVisibility="Horizontal"
                                      EnableRowVirtualization="True"
                                      VirtualizingPanel.IsVirtualizing="True"
                                      VirtualizingPanel.VirtualizationMode="Recycling">
                                <DataGrid.RowStyle>
                                    <Style TargetType="DataGridRow">
                                        <Setter Property="Background" Value="White"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Quality}" Value="{x:Static local:ServerQuality.Excelente}">
                                                <Setter Property="Background" Value="#E8F5E9"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Quality}" Value="{x:Static local:ServerQuality.Bom}">
                                                <Setter Property="Background" Value="#F1F8E9"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Quality}" Value="{x:Static local:ServerQuality.Regular}">
                                                <Setter Property="Background" Value="#FFF8E1"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Quality}" Value="{x:Static local:ServerQuality.Ruim}">
                                                <Setter Property="Background" Value="#FFEBEE"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGrid.RowStyle>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Servidor" Binding="{Binding Host}" Width="*"/>
                                    <DataGridTextColumn Header="Score" Binding="{Binding Score, StringFormat={}{0:F1}}" Width="65"/>
                                    <DataGridTextColumn Header="Qualidade" Binding="{Binding Quality}" Width="85"/>
                                    <DataGridTextColumn Header="Online" Binding="{Binding OnlineLinks}" Width="55"/>
                                    <DataGridTextColumn Header="Offline" Binding="{Binding OfflineLinks}" Width="55"/>
                                    <DataGridTextColumn Header="Taxa %" Binding="{Binding SuccessRate, StringFormat={}{0:F1}}" Width="65"/>
                                    <DataGridTextColumn Header="Resp. ms" Binding="{Binding AverageResponseMs, StringFormat={}{0:F0}}" Width="70"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </TabItem>
                    </TabControl>
                </Grid>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="3" Background="#F0F0F0" Padding="5,8" HorizontalAlignment="Stretch" VerticalAlignment="Bottom">
            <Grid VerticalAlignment="Center">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{Binding StatusMessage}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" Margin="0,0,10,0"/>
                <TextBlock Grid.Column="1" Text="{Binding CurrentVersionText}" VerticalAlignment="Center" Margin="0,0,8,0" FontWeight="SemiBold" FontSize="11"/>
                <Button Grid.Column="2" Content="Verificar Atualizações" Click="CheckUpdates_Click" Padding="10,4" Margin="0,0,8,0" Background="#FF9800" Foreground="White" FontSize="11" VerticalAlignment="Center"/>
                <Button Grid.Column="3" Content="Voltar Versão" Click="RollbackVersion_Click" Padding="10,4" Margin="0,0,8,0" Background="#455A64" Foreground="White" FontSize="11" VerticalAlignment="Center"/>
                <Button Grid.Column="4" Content="Abrir TXT VOD" Click="OpenVodLinksTxt_Click" Padding="10,4" Margin="0,0,8,0" FontSize="11" VerticalAlignment="Center"/>
                <Button Grid.Column="5" Content="Abrir TXT Canais" Click="OpenLiveLinksTxt_Click" Padding="10,4" Margin="0,0,8,0" FontSize="11" VerticalAlignment="Center"/>
                <Button Grid.Column="6" Content="Estatísticas BD" Click="ShowDatabaseStats_Click" Padding="10,4" Margin="0,0,8,0" Background="#673AB7" Foreground="White" FontSize="11" VerticalAlignment="Center"/>
                <Button Grid.Column="7" Content="GitHub" Click="OpenGitHub_Click" Padding="10,4" FontSize="11" VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <!-- Loading Overlay -->
        <Border Grid.Row="0" Grid.RowSpan="4" Background="#80000000" Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="Carregando..." Foreground="White" FontSize="16"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
