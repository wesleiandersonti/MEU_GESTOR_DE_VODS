name: Build

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: write
    runs-on: windows-latest
    steps:
      - name: Checkout (primary)
        id: checkout_primary
        uses: actions/checkout@v4
        continue-on-error: true

      - name: Checkout (retry)
        if: steps.checkout_primary.outcome == 'failure'
        uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Set Build Version
        shell: pwsh
        run: |
          if ("${{ github.ref }}".StartsWith("refs/tags/")) {
            $tag = "${{ github.ref_name }}"
            $num = $tag.TrimStart('v', 'V')
            "APP_VERSION=$tag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "APP_NUM_VERSION=$num" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            "APP_VERSION=dev-${{ github.run_number }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "APP_NUM_VERSION=1.0.0" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }

      - name: Validate Update Manifests
        shell: pwsh
        run: |
          if (!(Test-Path "app/update.json")) { throw "app/update.json nao encontrado" }
          if (!(Test-Path "update.json")) { throw "update.json da raiz nao encontrado" }

          $appManifest = Get-Content "app/update.json" -Raw | ConvertFrom-Json
          $rootManifest = Get-Content "update.json" -Raw | ConvertFrom-Json

          if ($appManifest.version -ne $rootManifest.version) {
            throw "Versao divergente entre app/update.json ($($appManifest.version)) e update.json ($($rootManifest.version))"
          }

          if ($appManifest.installerUrl -ne $rootManifest.installerUrl) {
            throw "installerUrl divergente entre app/update.json e update.json"
          }

          if ("${{ github.ref }}".StartsWith("refs/tags/")) {
            $expectedTag = "v$($env:APP_NUM_VERSION)"
            $expectedInstaller = "MeuGestorVODs-Setup-v$($env:APP_NUM_VERSION).exe"

            if ($appManifest.version -ne $env:APP_NUM_VERSION) {
              throw "Manifesto com versao $($appManifest.version), esperado $($env:APP_NUM_VERSION)"
            }

            if (-not $appManifest.installerUrl.Contains("/download/$expectedTag/$expectedInstaller")) {
              throw "installerUrl nao aponta para o asset esperado da tag $expectedTag"
            }
          }

      - name: Publish
        run: dotnet publish app/MeuGestorVODs.csproj -c Release -r win-x64 --self-contained -p:Version=${{ env.APP_NUM_VERSION }} -p:FileVersion=${{ env.APP_NUM_VERSION }} -p:AssemblyVersion=${{ env.APP_NUM_VERSION }} -o app/output

      - name: Write App Version File
        shell: pwsh
        run: Set-Content -Path app/output/version.txt -Value $env:APP_VERSION -Encoding utf8

      - name: Write Release Notes File
        shell: pwsh
        run: |
          $default = @(
            "Melhorias desta versao:",
            "- Ajustes visuais e de usabilidade.",
            "- Correcoes de estabilidade.",
            "- Aprimoramentos de desempenho."
          )

          if (Test-Path "app/update.json") {
            try {
              $manifest = Get-Content "app/update.json" -Raw | ConvertFrom-Json
              $version = if ($manifest.version) { [string]$manifest.version } else { $env:APP_VERSION }
              $notes = @()
              if ($manifest.notes) {
                foreach ($n in $manifest.notes) {
                  if ($n -and $n.ToString().Trim() -ne "") {
                    $notes += "- $($n.ToString().Trim())"
                  }
                }
              }

              if ($notes.Count -gt 0) {
                @("Versao: $version", "", "Melhorias implementadas:") + $notes |
                  Set-Content -Path app/output/release-notes.txt -Encoding utf8
              } else {
                $default | Set-Content -Path app/output/release-notes.txt -Encoding utf8
              }
            } catch {
              $default | Set-Content -Path app/output/release-notes.txt -Encoding utf8
            }
          } else {
            $default | Set-Content -Path app/output/release-notes.txt -Encoding utf8
          }

      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y

      - name: Build Installer
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "/DMyAppVersion=$env:APP_VERSION" "app/installer/MeuGestorVODs.iss"

      - name: Package Portable Zip
        shell: pwsh
        run: Compress-Archive -Path app/output/* -DestinationPath app/MeuGestorVODs-$env:APP_VERSION.zip

      - name: Upload Portable Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MeuGestorVODs-Portable-${{ env.APP_VERSION }}
          path: app/MeuGestorVODs-${{ env.APP_VERSION }}.zip

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MeuGestorVODs-Installer-${{ env.APP_VERSION }}
          path: app/installer-output/*.exe

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            app/MeuGestorVODs-${{ env.APP_VERSION }}.zip
            app/installer-output/*.exe
